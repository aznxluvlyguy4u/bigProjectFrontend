<div id="invoice-details">
    <div class="page-header">
        <div class="page-title">{{ pageTitle | translate }}</div>
    </div>

    <div *ngIf="!onlyView" class="row client-selection">
        <div class="large-6 columns">
            <label>
                {{ 'FIND COMPANY' | translate }}
            </label>

            <app-company-selector
                    [disabled]="false"
                    [selectedClient]="selectedCompany"
                    (selectedClientChanged)="selectedCompany = $event; setInvoiceRecipient()"
            ></app-company-selector>

        </div>

        <div *ngIf="selectedCompany != null" class="large-6 columns">
            <label>
                {{'LOCATION SELECTION' | translate }}
            </label>
            <select
                    name=""
                    [(ngModel)]="selectedUbn"
                    id="locations"
                    (click)="setInvoiceUbn()"
                    title="{{'SELECT LOCATION' | translate}}"
            >
                <option [value]=null>{{'NONE' | translate}}</option>
                <option *ngFor="let ubn of clientUbns" [value]="ubn">{{ubn}}</option>
            </select>
        </div>
    </div>
<hr>
    <div class="row information-overview">
        <div class="large-3 columns">
            <table>
                <tr>
                    <td class="large-12 columns section-title">
                        {{ 'CLIENT INFORMATION' | translate }}
                    </td>
                </tr>
                <tr >
                    <td class="large-6 columns">
                        {{ 'UBN' | translate }}
                    </td>
                    <td class="large-6 columns">
                        <span>
                            {{ invoice.ubn == null ? '-' : invoice.ubn }}
                        </span>
                    </td>
                </tr>
                <tr class="row">
                    <td class="large-6 columns">
                        {{ 'INVOICE NUMBER' | translate }}
                    </td>
                    <td class="large-6 columns">
                        {{ invoice.invoice_number}}
                    </td>
                </tr>
                <tr class="row">
                    <td class="large-6 columns">
                        {{ 'NAME' | translate }}
                    </td>
                    <td class="large-6 columns">
                        <span>
                            {{ invoice.company_name }}
                        </span>
                    </td>
                </tr>
                <tr class="row">
                    <td class="large-6 columns">
                        {{ 'VAT NUMBER' | translate }}
                    </td>
                    <td class="large-6 columns">
                        <span>
                            {{ invoice.company_vat_number }}
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div class="large-3 columns end">
            <table>
                <tr class="row">
                    <td class="large-6 columns section-title">
                        {{ 'YOUR INFORMATION' | translate }}
                    </td>
                    <td class="large-6 columns">

                        <ng-template *ngIf="isCreateMode() || isEditMode()">

                            <!-- TODO: DROPDOWN OPTION MENU DOESN'T WORK YET -->
                            <!--<button type="button" class="tiny dropdown button float-right" [attr.data-toggle]="'dropdown-sender-details-options'">-->
                                <!--{{ 'OPTIONS' | translate }}-->
                            <!--</button>-->
                            <!--<div class="dropdown-pane bottom" data-dropdown data-hover="true"-->
                                 <!--data-hover-pane="true" id="dropdown-sender-details-options">-->
                                <!--<ul>-->
                                    <!--<li>-->
                                        <!--<a (click)="refreshSenderDetails()"-->
                                           <!--title="{{ 'USE' | translate }} {{ 'LATEST VERSION' | translate | lowercase }}"-->
                                        <!--&gt;<i class="fa fa-refresh fa-2x" aria-hidden="true"></i></a>-->
                                    <!--</li>-->
                                    <!--<li>-->
                                        <!--<a (click)="navigateToInvoiceSenderDetailsEdit()"-->
                                           <!--title="{{ 'EDIT' | translate }} {{ 'LATEST VERSION' | translate | lowercase }}"-->
                                        <!--&gt;<i class="fa fa-pencil-square-o fa-fw fa-2x" aria-hidden="true"></i></a>-->
                                    <!--</li>-->
                                <!--</ul>-->
                            <!--</div>-->


                            <span
                                    class="pull-left"
                                    title="{{ 'USE' | translate }} {{ 'LATEST VERSION' | translate | lowercase }}"
                                    (click)="refreshSenderDetails()"
                            ><i class="fa fa-refresh fa-2x" aria-hidden="true"></i></span>
                            <span
                                    class="pull-right"
                                    title="{{ 'EDIT' | translate }} {{ 'LATEST VERSION' | translate | lowercase }}"
                                    (click)="navigateToInvoiceSenderDetailsEdit()"
                            ><i class="fa fa-pencil-square-o fa-fw fa-2x" aria-hidden="true"></i></span>
                        </ng-template>

                        <span *ngIf="isViewMode()"
                              class="pull-right"
                              title="{{ 'INVOICE SENDER DETAILS EDIT ONLY ALLOWED IF NOT SENT YET INFO' | translate }}"
                        ><i class="fa fa-info-circle" aria-hidden="true"></i></span>

                    </td>
                </tr>
                <tr class="row">
                    <td class="large-6 columns">
                        {{ 'NAME' | translate }}
                    </td>
                    <td class="large-6 columns">
                        <span>
                            {{ senderDetails ? senderDetails.name : '' }}
                        </span>
                    </td>
                </tr>
                <tr class="row">
                    <td class="large-6 columns">
                        {{ 'IBAN' | translate }}
                    </td>
                    <td class="large-6 columns">
                        <span>
                            {{ senderDetails? senderDetails.iban : ''}}
                        </span>
                    </td>
                </tr>
                <tr class="row">
                    <td class="large-6 columns">
                        {{ 'VAT NUMBER' | translate }}
                    </td>
                    <td class="large-6 columns">
                        <span>
                            {{ senderDetails ? senderDetails.vat_number : ''}}
                        </span>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <ng-template *ngIf="!onlyView">

        <hr>

        <div class="row invoice-rules">
            <div class="large-6 columns">

                <div class="row">
                    <div class="large-12 columns">
                        <h5>{{ 'GENERAL INVOICE RULE' | translate }}</h5>
                    </div>
                </div>

                <div class="row">
                    <div class="large-12 columns">
                        <select [(ngModel)]="selectedInvoiceRuleId">
                            <option value="">--</option>
                            <option *ngFor="let rule of standardGeneralInvoiceRuleOptions" value="{{ rule.id }}">{{ rule.description }}</option>
                        </select>
                    </div>
                </div>

            </div>
            <div class="large-2 columns end">
                <div class="row">
                    <h5>&nbsp;</h5>
                    <button (click)="addInvoiceRule('standard', 'GENERAL')" class="small primary button">
                        <i class="fa fa-plus fa-fw" aria-hidden="true"></i>
                        {{ 'ADD' | translate }}
                    </button>
                </div>
            </div>
        </div>

        <hr>

        <div class="row invoice-rules">

            <div [formGroup]="form" id="invoiceRule">

                <div class="large-6 columns">

                    <div class="row invoice-rules">
                        <div class="large-12 columns">
                            <h5>{{'CUSTOM INVOICE RULE' | translate }}</h5>
                        </div>
                    </div>

                    <div class="row">
                        <div class="large-4 columns">
                            <label class="middle"> {{ 'LEDGER CATEGORY' | translate }}</label>
                        </div>
                        <div class="large-8 columns">
                            <app-ledger-category-dropdown
                                    [selectedLedgerCategory]="temporaryRule.ledger_category"
                                    [disabled]="false"
                                    [activeOnly]="true"
                                    [displayActiveStatus]="true"
                                    (selectedLedgerCategoryChanged)="temporaryRule.ledger_category = $event"
                            ></app-ledger-category-dropdown>
                        </div>
                    </div>

                    <div class="row">
                        <div class="large-4 columns">
                            <label>
                                {{'DESCRIPTION' | translate}}
                            </label>
                        </div>
                        <div class="large-8 columns">
                            <textarea type="text" [(ngModel)]="temporaryRule.description" formControlName="description"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="large-4 columns">
                            <label>
                                {{'PRICE (EXCL. VAT)' | translate}}
                            </label>
                        </div>
                        <div class="large-8 columns">
                            <label *ngIf="!tempRulePriceExclVatDecimalCountIsValid()" class="input-error-msg" style="text-align: left">{{'CURRENCY CANNOT EXCEED 3 DECIMAL SPACES'|translate}}!</label>
                            <input
                                    type="number"
                                    [(ngModel)]="temporaryRule.price_excl_vat"
                                    formControlName="price_excl_vat"
                                    step="0.001"
                            >
                        </div>
                    </div>

                    <div class="row">
                        <div class="large-12">
                            <div class="large-4 columns">
                                <label>
                                    {{'VAT PERCENTAGE RATE' | translate}}
                                </label>
                            </div>
                            <div class="large-8 columns">
                                <select [(ngModel)]="temporaryRule.vat_percentage_rate" formControlName="vat_percentage_rate">
                                    <option *ngFor="let percentageNumber of getVatPercentages()" [value]="percentageNumber"> {{percentageNumber}}% </option>
                                </select>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="large-6 columns end">
                    <div class="row">
                        <h5>&nbsp;</h5>
                        <button [disabled]="!isCustomInvoiceRuleCreateButtonActive()" (click)="addInvoiceRule('custom', null)" class="small primary button">
                            <i class="fa fa-plus fa-fw" aria-hidden="true"></i>
                            {{ 'ADD' | translate }}
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <hr>

    </ng-template>

    <div class="row invoice-table">
        <div class="large-12 columns">
            <table>
                <thead>
                    <tr>
                        <td width="1"></td>
                        <td>
                            {{"CATEGORY" | translate }}
                        </td>
                        <td>
                            {{ 'DESCRIPTION' | translate }}
                        </td>
                        <td class="text-right">
                            {{ 'VAT RATE' | translate }}
                        </td>
                        <td class="text-right">
                            {{ 'PRICE' | translate }}
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let rule of invoice.invoice_rules">
                        <td width="1">
                            <i *ngIf="!onlyView" class="fa fa-times fa-fw remove-button" (click)="removeInvoiceRule(rule)" aria-hidden="true"></i>
                        </td>
                        <td>
                            {{rule.ledger_category ? rule.ledger_category.code + ': ' + rule.ledger_category.description : ''}}
                        </td>
                        <td>
                            {{rule.description}}
                        </td>
                        <td class="text-right">
                            {{rule.vat_percentage_rate}}%
                        </td>
                        <td class="text-right">
                            {{rule.price_excl_vat.toFixed(3)}}
                        </td>
                    </tr>
                    <tr>
                        <td *ngIf="invoice.invoice_rules.length == 0" colspan="4" class="text-center">
                            {{ 'ADD A INVOICE RULE' | translate }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="large-push-8 large-4 columns">
            <table>
                <tbody>
                    <tr>
                        <td> {{ 'TOTAL EXCL VAT' | translate }}</td>
                        <td>
                            <span class="pull-right">
                                {{ totalExclVAT.toFixed(3) }}
                            </span>
                        </td>
                    </tr>
                    <tr *ngFor="let vat of vatCalculations">
                        <td>
                            {{ vat.category }}% {{ 'VAT ON' | translate }} {{ vat.amount.toFixed(3) }}
                        </td>
                        <td>
                            <span class="pull-right">
                                {{ vat.total.toFixed(3) }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td> {{ 'TOTAL INCL VAT' | translate }}</td>
                        <td>
                            <span class="pull-right">
                                {{ totalInclVAT.toFixed(3) }}
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <span *ngIf="!onlyView" class="pull-right">
                <button [disabled]="!invoice.company_name" type="button" (click)="sendInvoiceToClient()" class="small primary button">
                    {{ 'SEND INVOICE' | translate }}
                </button>
                <button type="button" (click)="saveInvoice()" class="small primary button">
                    {{ 'SAVE' | translate }}
                </button>
                <button *ngIf="!onlyView"
                        [disabled]="(invoice.status != 'NOT SEND' && invoice.status != 'INCOMPLETE') || invoiceId == null"
                        type="button"
                        (click)="deleteInvoice()"
                        class="small alert button">
                    {{'DELETE' | translate}}
                </button>
                <button type="button" (click)="navigateTo('/invoice')" class="small primary button">
                    {{ 'RETURN' | translate }}
                </button>
            </span>
            <span *ngIf="onlyView" class="pull-right">
                <button type="button" (click)="navigateTo('/invoice')" class="small primary button">
                    {{ 'RETURN' | translate }}
                </button>
            </span>
        </div>
    </div>
</div>